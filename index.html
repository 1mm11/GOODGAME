<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOODGAME | SYSTEM CHECK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #status-box { border: 2px solid #0f0; padding: 20px; width: 100%; max-width: 600px; background: #001100; box-shadow: 0 0 20px #0f0; }
        .step { margin: 10px 0; opacity: 0.5; }
        .step.done { opacity: 1; color: #0f0; font-weight: bold; }
        .step.error { opacity: 1; color: #f00; font-weight: bold; animation: flash 1s infinite; }
        .step.working { color: yellow; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #login-form { display: none; margin-top: 20px; width: 100%; }
        input { background: #002200; border: 1px solid #0f0; color: #0f0; width: 100%; padding: 10px; margin-bottom: 10px; font-family: monospace; }
        button { background: #0f0; color: #000; border: none; padding: 10px; width: 100%; font-weight: bold; cursor: pointer; }
        button:hover { background: #fff; }
    </style>
</head>
<body>

<div id="status-box">
    <h1 class="text-2xl font-black mb-4 text-center">SYSTEM DIAGNOSTIC V33</h1>
    <div id="step-1" class="step working">> INITIALIZING APP...</div>
    <div id="step-2" class="step">> CONNECTING FIREBASE...</div>
    <div id="step-3" class="step">> CHECKING AUTH...</div>
    <div id="step-4" class="step">> CONNECTING DB...</div>
    <div id="step-5" class="step">> WAITING FOR USER...</div>
    
    <div id="error-log" class="mt-4 text-red-500 text-xs border-t border-red-900 pt-2 hidden"></div>

    <div id="login-form">
        <hr class="border-green-900 my-4">
        <p class="mb-2 text-center text-white">LOGIN REQUIRED</p>
        <input id="email" placeholder="Email" value="">
        <input id="pass" placeholder="Password (vlad01032014v)" type="password">
        <button onclick="tryLogin()">LOGIN / REGISTER</button>
    </div>
    
    <button onclick="forceReset()" class="mt-4 bg-red-900 text-white text-xs">FORCE RESET (CLEAR CACHE)</button>
</div>

<script type="module">
    // LOGGING HELPER
    function logStep(id, status, text) {
        const el = document.getElementById(id);
        el.className = 'step ' + status;
        if(text) el.innerText = '> ' + text;
    }
    function fatalError(msg) {
        document.getElementById('error-log').classList.remove('hidden');
        document.getElementById('error-log').innerText = "FATAL ERROR:\n" + msg;
        console.error(msg);
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    logStep('step-1', 'done', 'APP INIT OK');

    const firebaseConfig = {
      apiKey: "AIzaSyCRuH9VBPZNrmMwhr-rtYBELjKOPxwOt-Y",
      authDomain: "goodgame-88620.firebaseapp.com",
      projectId: "goodgame-88620",
      storageBucket: "goodgame-88620.firebasestorage.app",
      messagingSenderId: "1083203224860",
      appId: "1:1083203224860:web:ed69a751888e1ebf81a6d9",
      measurementId: "G-JEW9VW980B"
    };

    let app, auth, db;

    try {
        logStep('step-2', 'working', 'CONNECTING FIREBASE...');
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        logStep('step-2', 'done', 'FIREBASE CONNECTED');
    } catch(e) {
        logStep('step-2', 'error', 'FIREBASE FAILED');
        fatalError(e.message);
    }

    if(auth) {
        logStep('step-3', 'working', 'LISTENING AUTH...');
        onAuthStateChanged(auth, async (user) => {
            logStep('step-3', 'done', 'AUTH LISTENER ACTIVE');
            
            if (user) {
                logStep('step-5', 'done', 'USER FOUND: ' + user.email);
                logStep('step-4', 'working', 'READING DATABASE...');
                
                try {
                    const snap = await getDoc(doc(db, "users", user.uid));
                    if (snap.exists()) {
                        logStep('step-4', 'done', 'DATABASE READ OK');
                        alert("SUCCESS! SYSTEM IS WORKING. RELOADING TO GAME...");
                        // HERE WE WOULD LOAD THE GAME, BUT FOR NOW WE JUST REPORT SUCCESS
                        document.body.innerHTML = '<h1 style="color:white;text-align:center">SYSTEM GREEN. YOU CAN INSTALL THE GAME CODE NOW.</h1>';
                    } else {
                        logStep('step-4', 'error', 'USER NOT IN DB (GHOST)');
                        await signOut(auth);
                        location.reload();
                    }
                } catch(e) {
                    logStep('step-4', 'error', 'DB ERROR (Check Rules!)');
                    fatalError(e.message);
                }
            } else {
                logStep('step-5', 'working', 'NO USER - SHOWING LOGIN');
                document.getElementById('login-form').style.display = 'block';
            }
        });
    }

    window.tryLogin = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        if(!e || !p) return alert("Enter details");
        
        try {
            await signInWithEmailAndPassword(auth, e, p);
        } catch(err) {
            console.log("Login failed, trying reg...", err.code);
            try {
                const res = await createUserWithEmailAndPassword(auth, e, p);
                // Create DB Doc
                await setDoc(doc(db, "users", res.user.uid), {
                    nickname: "GOODGAME",
                    balance: 1000,
                    role: "admin",
                    email: e
                });
                alert("REGISTERED & DB CREATED!");
            } catch(regErr) {
                fatalError(regErr.message);
            }
        }
    };

    window.forceReset = () => {
        localStorage.clear();
        location.reload();
    };
</script>
</body>
</html>
